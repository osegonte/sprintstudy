<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Planner - Smart PDF Reader</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --bg-primary: #f7fafc;
            --bg-secondary: #edf2f7;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-lg: 0 10px 40px rgba(0,0,0,0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--bg-primary);
            box-shadow: var(--shadow-lg);
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }

        .user-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--border);
            position: fixed;
            left: 0;
            top: 80px;
            bottom: 0;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            margin-left: 280px;
            padding: 30px;
            min-height: calc(100vh - 80px);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            fill: none;
            stroke-width: 8;
        }

        .progress-ring-bg {
            stroke: var(--bg-secondary);
        }

        .progress-ring-progress {
            stroke: var(--primary);
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-lg {
            padding: 16px 32px;
            font-size: 18px;
        }

        .topic-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .topic-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .topic-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 12px;
        }

        .topic-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .topic-progress {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }

        .topic-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .pdf-viewer-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            position: relative;
        }

        .pdf-controls {
            background: var(--bg-secondary);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .pdf-canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            cursor: pointer;
        }

        .reading-tracker {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 250px;
        }

        .timer-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary);
            text-align: center;
            margin-bottom: 16px;
        }

        .performance-feedback {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin: 12px 0;
            font-weight: 600;
        }

        .feedback-fast {
            background: #e6fffa;
            color: #38b2ac;
        }

        .feedback-perfect {
            background: #f0fff4;
            color: var(--success);
        }

        .feedback-slow {
            background: #fffbeb;
            color: var(--warning);
        }

        .sprint-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }

        .sprint-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 12px;
        }

        .sprint-details {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .celebration-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            text-align: center;
            min-width: 300px;
        }

        .celebration-emoji {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .navbar {
            list-style: none;
            margin-bottom: 30px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg-secondary);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .file-upload-zone {
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-zone:hover {
            border-color: var(--primary-dark);
            background: #f0f4ff;
        }

        .achievement-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px;
        }

        .streak-counter {
            background: linear-gradient(135deg, #ff9a56, #ff6b6b);
            color: white;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            
            .reading-tracker {
                position: static;
                transform: none;
                margin: 20px 0;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // API Configuration
        const API_BASE_URL = 'http://localhost:3000';

        // API Helper
        const api = {
            async request(endpoint, options = {}) {
                const token = localStorage.getItem('token');
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` }),
                        ...options.headers,
                    },
                };

                try {
                    const response = await axios(`${API_BASE_URL}${endpoint}`, config);
                    return { data: response.data, error: null };
                } catch (error) {
                    console.error('API Error:', error);
                    return { 
                        data: null, 
                        error: error.response?.data?.error || error.message || 'Network error' 
                    };
                }
            },

            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            },

            async post(endpoint, data) {
                return this.request(endpoint, { method: 'POST', data });
            },

            async patch(endpoint, data) {
                return this.request(endpoint, { method: 'PATCH', data });
            },

            async delete(endpoint) {
                return this.request(endpoint, { method: 'DELETE' });
            },

            async uploadFile(endpoint, formData) {
                const token = localStorage.getItem('token');
                try {
                    const response = await axios.post(`${API_BASE_URL}${endpoint}`, formData, {
                        headers: {
                            'Content-Type': 'multipart/form-data',
                            ...(token && { 'Authorization': `Bearer ${token}` }),
                        },
                    });
                    return { data: response.data, error: null };
                } catch (error) {
                    return { 
                        data: null, 
                        error: error.response?.data?.error || error.message || 'Upload failed' 
                    };
                }
            }
        };

        // Progress Ring Component
        function ProgressRing({ progress, size = 120, strokeWidth = 8 }) {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const offset = circumference - (progress / 100) * circumference;

            return (
                <svg className="progress-ring" width={size} height={size}>
                    <circle
                        className="progress-ring-circle progress-ring-bg"
                        cx={size / 2}
                        cy={size / 2}
                        r={radius}
                        strokeWidth={strokeWidth}
                    />
                    <circle
                        className="progress-ring-circle progress-ring-progress"
                        cx={size / 2}
                        cy={size / 2}
                        r={radius}
                        strokeWidth={strokeWidth}
                        strokeDasharray={circumference}
                        strokeDashoffset={offset}
                    />
                </svg>
            );
        }

        // Authentication Component
        function AuthForm({ onLogin }) {
            const [isLogin, setIsLogin] = useState(true);
            const [loading, setLoading] = useState(false);
            const [formData, setFormData] = useState({
                email: 'test2@example.com',
                password: 'password123',
                username: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                const endpoint = isLogin ? '/api/auth/login' : '/api/auth/signup';
                const { data, error } = await api.post(endpoint, formData);

                if (error) {
                    alert(`${isLogin ? 'Login' : 'Signup'} failed: ${error}`);
                } else {
                    localStorage.setItem('token', data.session.access_token);
                    onLogin(data.user);
                }

                setLoading(false);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h2>{isLogin ? '🔐 Welcome Back' : '📚 Join Study Planner'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="form-group">
                                <label className="form-label">Email:</label>
                                <input
                                    type="email"
                                    className="form-control"
                                    value={formData.email}
                                    onChange={(e) => setFormData({...formData, email: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label className="form-label">Password:</label>
                                <input
                                    type="password"
                                    className="form-control"
                                    value={formData.password}
                                    onChange={(e) => setFormData({...formData, password: e.target.value})}
                                    required
                                />
                            </div>
                            {!isLogin && (
                                <div className="form-group">
                                    <label className="form-label">Username (optional):</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.username}
                                        onChange={(e) => setFormData({...formData, username: e.target.value})}
                                    />
                                </div>
                            )}
                            <button type="submit" className="btn btn-primary btn-lg" disabled={loading} style={{width: '100%', marginBottom: '16px'}}>
                                {loading && <span className="loading"></span>}
                                {isLogin ? 'Login' : 'Create Account'}
                            </button>
                        </form>
                        <button 
                            className="btn" 
                            onClick={() => setIsLogin(!isLogin)}
                            style={{width: '100%', background: 'transparent', color: 'var(--primary)'}}
                        >
                            {isLogin ? 'Need an account? Sign Up' : 'Have an account? Login'}
                        </button>
                    </div>
                </div>
            );
        }

        // Dashboard Component
        function Dashboard({ user }) {
            const [dashboardData, setDashboardData] = useState(null);
            const [todaySprint, setTodaySprint] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                loadDashboard();
                loadTodaySprint();
            }, []);

            const loadDashboard = async () => {
                const { data, error } = await api.get('/api/dashboard');
                if (!error) {
                    setDashboardData(data);
                }
                setLoading(false);
            };

            const loadTodaySprint = async () => {
                const { data, error } = await api.get('/api/sprints/today');
                if (!error) {
                    setTodaySprint(data.sprint);
                }
            };

            const startSprint = async () => {
                if (todaySprint) {
                    const { error } = await api.patch(`/api/sprints/${todaySprint.id}/start`);
                    if (!error) {
                        loadTodaySprint();
                    }
                }
            };

            if (loading) {
                return (
                    <div style={{textAlign: 'center', padding: '60px'}}>
                        <span className="loading" style={{width: '40px', height: '40px'}}></span>
                        <p style={{marginTop: '20px'}}>Loading your dashboard...</p>
                    </div>
                );
            }

            const overview = dashboardData?.overview || {};
            const insights = dashboardData?.reading_insights || [];

            return (
                <div>
                    <h1 style={{marginBottom: '30px', color: 'var(--text-primary)'}}>
                        Welcome back, {user.email}! 👋
                    </h1>

                    {/* Today's Sprint */}
                    {todaySprint && (
                        <div className="sprint-card">
                            <div className="sprint-title">🎯 Today's Sprint</div>
                            <div className="sprint-details">
                                {todaySprint.documents?.title}<br/>
                                Pages {todaySprint.start_page}-{todaySprint.end_page} • {Math.round(todaySprint.estimated_time_seconds / 60)} min
                            </div>
                            {todaySprint.status === 'pending' && (
                                <button className="btn btn-success btn-lg pulse" onClick={startSprint}>
                                    🚀 Start Sprint
                                </button>
                            )}
                            {todaySprint.status === 'in_progress' && (
                                <button className="btn btn-success btn-lg">
                                    📖 Continue Reading
                                </button>
                            )}
                            {todaySprint.status === 'completed' && (
                                <div style={{background: 'rgba(255,255,255,0.2)', borderRadius: '8px', padding: '12px'}}>
                                    ✅ Sprint Completed! Great job!
                                </div>
                            )}
                        </div>
                    )}

                    {/* Stats Grid */}
                    <div className="dashboard-grid">
                        <div className="stat-card">
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <div>
                                    <div className="stat-number">{overview.total_documents || 0}</div>
                                    <div className="stat-label">Total PDFs</div>
                                </div>
                                <div style={{fontSize: '3rem'}}>📚</div>
                            </div>
                        </div>

                        <div className="stat-card">
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <div>
                                    <div className="stat-number">{overview.completion_percentage || 0}%</div>
                                    <div className="stat-label">Overall Progress</div>
                                </div>
                                <ProgressRing progress={overview.completion_percentage || 0} size={80} />
                            </div>
                        </div>

                        <div className="stat-card">
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <div>
                                    <div className="stat-number">{Math.round((overview.total_time_spent_seconds || 0) / 60)}</div>
                                    <div className="stat-label">Minutes Read</div>
                                </div>
                                <div style={{fontSize: '3rem'}}>⏱️</div>
                            </div>
                        </div>

                        <div className="stat-card">
                            <div style={{display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <div>
                                    <div className="stat-number">{Math.round((overview.average_reading_speed_seconds || 0) / 60)}</div>
                                    <div className="stat-label">Avg Min/Page</div>
                                </div>
                                <div style={{fontSize: '3rem'}}>📊</div>
                            </div>
                        </div>
                    </div>

                    {/* Reading Insights */}
                    {insights.length > 0 && (
                        <div className="stat-card">
                            <h3 style={{marginBottom: '16px'}}>💡 Reading Insights</h3>
                            {insights.map((insight, index) => (
                                <div key={index} style={{
                                    background: 'var(--bg-secondary)',
                                    borderRadius: '8px',
                                    padding: '12px',
                                    margin: '8px 0',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px'
                                }}>
                                    <span style={{fontSize: '1.5rem'}}>{insight.icon}</span>
                                    <span>{insight.message}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Topics Component (placeholder for future development)
        function Topics() {
            return (
                <div>
                    <h1 style={{marginBottom: '30px'}}>📂 Study Topics</h1>
                    <div className="stat-card" style={{textAlign: 'center', padding: '60px'}}>
                        <div style={{fontSize: '4rem', marginBottom: '20px'}}>🚧</div>
                        <h3>Coming Soon!</h3>
                        <p style={{color: 'var(--text-secondary)', marginTop: '12px'}}>
                            Organize your PDFs by topic and set exam goals
                        </p>
                    </div>
                </div>
            );
        }

        // Documents Component
        function Documents({ onOpenReader }) {
            const [documents, setDocuments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showUpload, setShowUpload] = useState(false);

            useEffect(() => {
                loadDocuments();
            }, []);

            const loadDocuments = async () => {
                const { data, error } = await api.get('/api/documents');
                if (!error) {
                    setDocuments(data.documents || []);
                }
                setLoading(false);
            };

            const handleRead = (doc) => {
                onOpenReader(doc);
            };

            if (loading) {
                return <div><span className="loading"></span> Loading documents...</div>;
            }

            return (
                <div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px'}}>
                        <h1>📚 My Documents ({documents.length})</h1>
                        <button className="btn btn-primary" onClick={() => setShowUpload(true)}>
                            📤 Upload PDF
                        </button>
                    </div>

                    {documents.length === 0 ? (
                        <div className="stat-card" style={{textAlign: 'center', padding: '60px'}}>
                            <div style={{fontSize: '4rem', marginBottom: '20px'}}>📄</div>
                            <h3>No documents yet</h3>
                            <p style={{color: 'var(--text-secondary)', marginTop: '12px', marginBottom: '20px'}}>
                                Upload your first PDF to start tracking your reading progress
                            </p>
                            <button className="btn btn-primary" onClick={() => setShowUpload(true)}>
                                📤 Upload First PDF
                            </button>
                        </div>
                    ) : (
                        <div>
                            {documents.map(doc => (
                                <div key={doc.id} className="topic-card">
                                    <div className="topic-header">
                                        <div>
                                            <div className="topic-title">{doc.title}</div>
                                            <div style={{color: 'var(--text-secondary)', fontSize: '0.9rem'}}>
                                                {doc.total_pages} pages • {new Date(doc.created_at).toLocaleDateString()}
                                            </div>
                                        </div>
                                        <button className="btn btn-primary" onClick={() => handleRead(doc)}>
                                            📖 Read
                                        </button>
                                    </div>
                                    
                                    <div className="topic-progress">
                                        <div 
                                            className="topic-progress-fill" 
                                            style={{width: `${doc.completion_percentage}%`}}
                                        ></div>
                                    </div>
                                    
                                    <div style={{display: 'flex', justifyContent: 'space-between', fontSize: '0.9rem', color: 'var(--text-secondary)'}}>
                                        <span>{doc.completed_pages}/{doc.total_pages} pages ({doc.completion_percentage}%)</span>
                                        <span>{Math.round(doc.total_time_spent_seconds / 60)} min read</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {showUpload && <UploadModal onClose={() => setShowUpload(false)} onSuccess={loadDocuments} />}
                </div>
            );
        }

        // Upload Modal Component
        function UploadModal({ onClose, onSuccess }) {
            const [uploading, setUploading] = useState(false);
            const [dragOver, setDragOver] = useState(false);

            const handleFileUpload = async (file) => {
                if (!file || file.type !== 'application/pdf') {
                    alert('Please select a PDF file');
                    return;
                }

                setUploading(true);
                const formData = new FormData();
                formData.append('pdf', file);
                formData.append('title', file.name.replace('.pdf', ''));

                const { data, error } = await api.uploadFile('/api/documents/upload', formData);

                if (error) {
                    alert(`Upload failed: ${error}`);
                } else {
                    alert('Document uploaded successfully! 📚');
                    onSuccess();
                    onClose();
                }

                setUploading(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                const file = e.dataTransfer.files[0];
                handleFileUpload(file);
            };

            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                handleFileUpload(file);
            };

            return (
                <div className="modal-overlay">
                    <div className="modal">
                        <h2>📤 Upload PDF Document</h2>
                        <div 
                            className={`file-upload-zone ${dragOver ? 'drag-over' : ''}`}
                            onDrop={handleDrop}
                            onDragOver={(e) => { e.preventDefault(); setDragOver(true); }}
                            onDragLeave={() => setDragOver(false)}
                            onClick={() => document.getElementById('file-input').click()}
                        >
                            {uploading ? (
                                <div>
                                    <span className="loading"></span>
                                    <p>Uploading PDF...</p>
                                </div>
                            ) : (
                                <div>
                                    <div style={{fontSize: '3rem', marginBottom: '16px'}}>📁</div>
                                    <p>Drop PDF file here or click to browse</p>
                                    <p style={{color: '#666', fontSize: '0.9rem', marginTop: '8px'}}>Max file size: 50MB</p>
                                </div>
                            )}
                        </div>
                        <input
                            id="file-input"
                            type="file"
                            accept=".pdf"
                            onChange={handleFileSelect}
                            style={{display: 'none'}}
                        />
                        <button className="btn" onClick={onClose} style={{marginTop: '20px', width: '100%'}}>
                            Cancel
                        </button>
                    </div>
                </div>
            );
        }

        // PDF Reader Component
        function PDFReader({ document, onClose }) {
            const [currentPage, setCurrentPage] = useState(1);
            const [isTracking, setIsTracking] = useState(false);
            const [startTime, setStartTime] = useState(null);
            const [timeSpent, setTimeSpent] = useState(0);
            const [performance, setPerformance] = useState(null);
            const [showCelebration, setShowCelebration] = useState(false);
            const canvasRef = useRef(null);
            const pdfDocRef = useRef(null);

            useEffect(() => {
                loadPDF();
            }, [document]);

            useEffect(() => {
                let interval;
                if (isTracking && startTime) {
                    interval = setInterval(() => {
                        const currentTime = Math.floor((Date.now() - startTime) / 1000);
                        setTimeSpent(currentTime);
                        updatePerformance(currentTime);
                    }, 1000);
                }
                return () => clearInterval(interval);
            }, [isTracking, startTime]);

            const loadPDF = async () => {
                try {
                    // In a real app, you'd load the PDF from Supabase storage
                    // For now, we'll create a placeholder
                    console.log('Loading PDF:', document.title);
                    renderPlaceholderPage();
                } catch (error) {
                    console.error('Error loading PDF:', error);
                }
            };

            const renderPlaceholderPage = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                canvas.width = 600;
                canvas.height = 800;

                // White background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Border
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 2;
                ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);

                // Title
                ctx.fillStyle = '#333';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(document.title, canvas.width / 2, 80);

                // Page number
                ctx.font = '18px Arial';
                ctx.fillText(`Page ${currentPage} of ${document.total_pages}`, canvas.width / 2, 120);

                // Placeholder content
                ctx.font = '16px Arial';
                ctx.textAlign = 'left';
                const lines = [
                    'This is a placeholder for the PDF content.',
                    'In the production version, the actual PDF',
                    'would be rendered here using PDF.js.',
                    '',
                    'You can still test the reading tracker',
                    'and timing features by clicking "Start Reading"',
                    'and navigating between pages.',
                    '',
                    'The app will track your reading time',
                    'and provide real-time feedback on',
                    'your reading pace compared to your',
                    'personal average.',
                ];

                lines.forEach((line, index) => {
                    ctx.fillText(line, 50, 180 + (index * 25));
                });
            };

            const updatePerformance = (currentTime) => {
                // Simulate performance calculation
                const avgTime = 120; // 2 minutes average per page
                const difference = currentTime - avgTime;
                
                if (Math.abs(difference) < 15) {
                    setPerformance({ type: 'perfect', message: '🎯 Perfect Pace!', difference: 0 });
                } else if (difference < -30) {
                    setPerformance({ type: 'fast', message: '⚡ Fast Today!', difference });
                } else if (difference > 60) {
                    setPerformance({ type: 'slow', message: '🐢 Take Your Time', difference });
                } else {
                    setPerformance(null);
                }
            };

            const startReading = () => {
                setIsTracking(true);
                setStartTime(Date.now());
                setTimeSpent(0);
                setPerformance(null);
            };

            const stopReading = async () => {
                if (!isTracking) return;

                setIsTracking(false);
                
                // Record progress
                const { error } = await api.post('/api/progress/page', {
                    document_id: document.id,
                    page_number: currentPage,
                    time_spent_seconds: timeSpent
                });

                if (!error) {
                    setShowCelebration(true);
                    setTimeout(() => setShowCelebration(false), 3000);
                }
            };

            const markComplete = async () => {
                const { error } = await api.patch(`/api/progress/page/${document.id}/${currentPage}/complete`, {
                    is_completed: true
                });

                if (!error) {
                    alert('Page marked as complete! ✅');
                }
            };

            const nextPage = () => {
                if (currentPage < document.total_pages) {
                    setCurrentPage(prev => prev + 1);
                    renderPlaceholderPage();
                }
            };

            const prevPage = () => {
                if (currentPage > 1) {
                    setCurrentPage(prev => prev - 1);
                    renderPlaceholderPage();
                }
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            return (
                <div className="app-container" style={{position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 1000}}>
                    <div className="header">
                        <div className="logo">
                            📖 {document.title}
                        </div>
                        <div className="user-controls">
                            <span style={{color: 'var(--text-secondary)'}}>
                                Page {currentPage} of {document.total_pages}
                            </span>
                            <button className="btn btn-primary" onClick={onClose}>
                                ← Back to Documents
                            </button>
                        </div>
                    </div>

                    <div style={{display: 'flex', height: 'calc(100vh - 80px)'}}>
                        <div style={{flex: 1, display: 'flex', flexDirection: 'column'}}>
                            {/* PDF Controls */}
                            <div className="pdf-controls">
                                <button className="btn" onClick={prevPage} disabled={currentPage === 1}>
                                    ← Previous
                                </button>
                                
                                <div style={{display: 'flex', gap: '12px'}}>
                                    <button 
                                        className={`btn ${isTracking ? 'btn-danger' : 'btn-success'}`}
                                        onClick={isTracking ? stopReading : startReading}
                                    >
                                        {isTracking ? '⏸️ Stop Reading' : '▶️ Start Reading'}
                                    </button>
                                    <button className="btn btn-primary" onClick={markComplete}>
                                        ✅ Mark Complete
                                    </button>
                                </div>

                                <button className="btn" onClick={nextPage} disabled={currentPage === document.total_pages}>
                                    Next →
                                </button>
                            </div>

                            {/* PDF Canvas */}
                            <div style={{flex: 1, overflow: 'auto', background: '#f5f5f5', display: 'flex', justifyContent: 'center', alignItems: 'center'}}>
                                <canvas 
                                    ref={canvasRef}
                                    className="pdf-canvas"
                                    style={{boxShadow: 'var(--shadow-lg)', background: 'white'}}
                                />
                            </div>
                        </div>

                        {/* Reading Tracker */}
                        <div className="reading-tracker">
                            <h3 style={{textAlign: 'center', marginBottom: '16px'}}>📊 Reading Tracker</h3>
                            
                            <div className="timer-display">
                                {formatTime(timeSpent)}
                            </div>

                            <div style={{textAlign: 'center', marginBottom: '16px'}}>
                                {isTracking ? (
                                    <span style={{color: 'var(--success)', fontWeight: 'bold'}}>
                                        ⏳ Tracking...
                                    </span>
                                ) : (
                                    <span style={{color: 'var(--text-secondary)'}}>
                                        ⏸️ Not tracking
                                    </span>
                                )}
                            </div>

                            {performance && (
                                <div className={`performance-feedback feedback-${performance.type}`}>
                                    {performance.message}
                                    {performance.difference !== 0 && (
                                        <div style={{fontSize: '0.8rem', marginTop: '4px'}}>
                                            {performance.difference > 0 ? '+' : ''}{performance.difference}s vs avg
                                        </div>
                                    )}
                                </div>
                            )}

                            <div style={{background: 'var(--bg-secondary)', borderRadius: '8px', padding: '12px', marginTop: '16px'}}>
                                <h4 style={{marginBottom: '8px'}}>📈 Session Stats</h4>
                                <div style={{fontSize: '0.9rem', color: 'var(--text-secondary)'}}>
                                    <div>Current Page: {currentPage}</div>
                                    <div>Time This Page: {formatTime(timeSpent)}</div>
                                    <div>Progress: {Math.round((currentPage / document.total_pages) * 100)}%</div>
                                </div>
                            </div>

                            <div className="streak-counter">
                                <div style={{fontSize: '1.2rem', fontWeight: 'bold'}}>🔥 Daily Streak</div>
                                <div style={{fontSize: '2rem'}}>3</div>
                                <div style={{fontSize: '0.8rem', opacity: 0.9}}>Keep it up!</div>
                            </div>
                        </div>
                    </div>

                    {/* Celebration Popup */}
                    {showCelebration && (
                        <div className="celebration-popup">
                            <div className="celebration-emoji">🎉</div>
                            <h3>Great Progress!</h3>
                            <p>You've logged {formatTime(timeSpent)} on this page</p>
                            <button className="btn btn-primary" onClick={() => setShowCelebration(false)}>
                                Continue Reading
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [currentView, setCurrentView] = useState('dashboard');
            const [readerDocument, setReaderDocument] = useState(null);
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                checkAuth();
            }, []);

            const checkAuth = async () => {
                const token = localStorage.getItem('token');
                if (token) {
                    const { data, error } = await api.get('/api/auth/me');
                    if (!error && data.user) {
                        setUser(data.user);
                    } else {
                        localStorage.removeItem('token');
                    }
                }
                setLoading(false);
            };

            const handleLogin = (userData) => {
                setUser(userData);
            };

            const handleLogout = async () => {
                await api.post('/api/auth/logout');
                localStorage.removeItem('token');
                setUser(null);
                setCurrentView('dashboard');
            };

            const openReader = (document) => {
                setReaderDocument(document);
            };

            const closeReader = () => {
                setReaderDocument(null);
            };

            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '100vh',
                        flexDirection: 'column'
                    }}>
                        <span className="loading" style={{width: '50px', height: '50px'}}></span>
                        <p style={{marginTop: '20px', color: 'white'}}>Loading Study Planner...</p>
                    </div>
                );
            }

            if (!user) {
                return <AuthForm onLogin={handleLogin} />;
            }

            if (readerDocument) {
                return <PDFReader document={readerDocument} onClose={closeReader} />;
            }

            return (
                <div className="app-container">
                    <div className="header">
                        <div className="logo">
                            📚 Study Planner
                        </div>
                        <div className="user-controls">
                            <span style={{color: 'var(--text-secondary)'}}>
                                {user.email}
                            </span>
                            <button className="btn" onClick={handleLogout}>
                                Logout
                            </button>
                        </div>
                    </div>

                    <div className="sidebar">
                        <ul className="navbar">
                            <li 
                                className={`nav-item ${currentView === 'dashboard' ? 'active' : ''}`}
                                onClick={() => setCurrentView('dashboard')}
                            >
                                📊 Dashboard
                            </li>
                            <li 
                                className={`nav-item ${currentView === 'documents' ? 'active' : ''}`}
                                onClick={() => setCurrentView('documents')}
                            >
                                📚 Documents
                            </li>
                            <li 
                                className={`nav-item ${currentView === 'topics' ? 'active' : ''}`}
                                onClick={() => setCurrentView('topics')}
                            >
                                📂 Topics
                            </li>
                            <li 
                                className={`nav-item ${currentView === 'sprints' ? 'active' : ''}`}
                                onClick={() => setCurrentView('sprints')}
                            >
                                🎯 Sprints
                            </li>
                        </ul>

                        <div style={{background: 'var(--bg-secondary)', borderRadius: '8px', padding: '16px'}}>
                            <h4 style={{marginBottom: '12px'}}>🏆 Achievements</h4>
                            <div className="achievement-badge">First PDF 📚</div>
                            <div className="achievement-badge">Fast Reader ⚡</div>
                            <div className="achievement-badge">3-Day Streak 🔥</div>
                        </div>
                    </div>

                    <div className="main-content">
                        {currentView === 'dashboard' && <Dashboard user={user} />}
                        {currentView === 'documents' && <Documents onOpenReader={openReader} />}
                        {currentView === 'topics' && <Topics />}
                        {currentView === 'sprints' && <Topics />}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>